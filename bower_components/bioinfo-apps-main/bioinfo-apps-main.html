<link rel="import" href="../polymer/polymer.html">
<link rel="stylesheet" href="../font-awesome/css/font-awesome.css">
<link rel="import" href="../app-collection/bz-collection.html">

<link rel="import" href="../app-info/app-info.html">
<link rel="import" href="../carbon-route/carbon-location.html">
<link rel="import" href="../carbon-route/carbon-route.html">
<link rel="import" href="../app-search/app-search.html">

<dom-module id="bioinfo-apps-main">
    <template>
        <style is="custom-style" include="iron-flex">

            :root {
                font-family: Lato;
            }


            .container{
                -webkit-overflow-scrolling: touch;
            }

            .menu_wrapper{
                width: 150px;
                height: 100%;
                position: absolute;
                overflow-x: hidden;
            }

            .search_box {
                position: absolute;
                right: 2em;
                top: 2em;
                z-index: 2;
            }

            bz-collection {
                display: block;
                width: 150px;
                position: absolute;
                transform: translate(-150px, 0);
                transition: transform 0.5s;

                padding-right: 40px;
                height: 100vh;
                overflow-y: scroll;
                overflow-x: hidden;
            }


            bz-collection[show] {
                z-index: 100;
                transform: translate(0);
            }

            app-info {
                position: absolute;
                top: 0;
                left: 0;
                transition: left 0.6s;
                height: 100vh;
                overflow-y: scroll;
            }

            .blocking_div{
                width: 100%;
                height: 100%;
                top: 0;
                position: fixed;

                background-color: rgba(0,0,0,0.2);

                z-index: 50;
            }

            @media screen and (min-width: 1200px){
                app-info {
                    left: 150px;
                }

                bz-collection {
                    transform: translate(0);
                }
            }
        </style>

        <carbon-location route="{{route}}"
                         use-hash-as-path></carbon-location>
        <carbon-route route="{{route}}"
                      pattern="/:application"
                      data="{{applicationData}}"></carbon-route>


        <div class="container">
            <div class="menu_wrapper">
                <bz-collection id="bzCollection"
                               tabindex="-1"
                               route="{{route}}"></bz-collection>
            </div>

            <app-search class="search_box" id="searchBox"></app-search>

            <app-info id="appInfo"
                      on-click-menu="_handleShowMenu"></app-info>

            <div class="blocking_div" id="blockingDiv" on-click="hideMenu" hidden></div>
        </div>
    </template>
    <script>
        Polymer({
            is: "bioinfo-apps-main",

            properties: {
                route: {
                    type: Object,
                    observer: "_handleUrl"
                },
                data: Array/Object
            },

            ready: function() {
                jsonRequest("src/test-apps.json", function(response){
                    this.$.bzCollection.appCollectionJson = response;
                    this.data = response;
                    this.$.searchBox.db = response;
                }.bind(this));
            },

            hideMenu: function(){
                Polymer.dom(this.$.bzCollection).removeAttribute("show");
                Polymer.dom(this.$.blockingDiv).setAttribute("hidden", "");
            },

            _handleShowMenu: function(){
                this.$.bzCollection.setAttribute("show", "");
                this.$.blockingDiv.removeAttribute("hidden");
            },

            _handleUrl: function(){
                function searchApp(app){
                    var appOnRoute = this.applicationData.application.toLowerCase();
                    return appOnRoute === app.name.toLowerCase();
                }

                if(!this.route.path){
                    this.set("route.path", "/babelomics");
                }

//                Needed to be async because in the first load of the page the data isn't set in time
                this.async(function(){
                    this.hideMenu();
                    var app = this.data.find(searchApp, this);
                    this.$.appInfo.appToDisplay = app;
                    console.log("fire");
                }, 200);
            }

        })
    </script>
</dom-module>