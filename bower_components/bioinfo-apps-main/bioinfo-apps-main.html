<link rel="import" href="../polymer/polymer.html">
<link rel="stylesheet" href="../font-awesome/css/font-awesome.css">
<link rel="import" href="../bz-sidebar/bz-collection.html">

<link rel="import" href="../app-info/app-info.html">
<link rel="import" href="../carbon-route/carbon-location.html">
<link rel="import" href="../carbon-route/carbon-route.html">
<link rel="import" href="../app-search/app-search.html">

<dom-module id="bioinfo-apps-main">
    <template>
        <style is="custom-style" include="iron-flex">

            :root {
                font-family: Lato;
            }

            :host {
                width: 100%;
                height: 100%;
            }

            ::-webkit-scrollbar{
                display: none;
            }

            .container{
                width: 100vw;
                -webkit-overflow-scrolling: touch;
            }

            /* Sidebar styles */
            .menu_wrapper{
                z-index: 100;
                position: fixed;
                transform: translate(-150px, 0);
                transition: transform 0.5s;
                box-sizing: border-box;
            }

            .menu_wrapper[show]{
                transform: translate(0);
            }

            bz-collection {
                width: 150px;
            }

            app-info {
                position: absolute;
                top: 0;
                left: 0;
                transition: left 0.6s;
                height: 100vh;
                overflow-y: scroll;
            }

            .blocking_div{
                width: 100%;
                height: 100%;
                top: 0;
                position: fixed;

                background-color: rgba(0,0,0,0.2);

                z-index: 50;
            }

            @media screen and (min-width: 1200px){
                app-info {
                    margin-left: 150px;
                }

                .menu_wrapper {
                    transform: translate(0);
                }

                /* Made with opacity instead of display: none because of no affecting the Flex layout*/
                .banner_item.menu_burger {
                    display: none;
                }
            }

            @media screen and (max-height: 530px), screen and (max-width: 400px){
                .search_box {
                    display: none;
                }
            }
        </style>

        <carbon-location route="{{route}}"
                         use-hash-as-path></carbon-location>
        <carbon-route route="{{route}}"
                      pattern="/:application"
                      data="{{applicationData}}"></carbon-route>


        <div class="container">
            <div class="menu_wrapper" id="menuWrapper">
                <bz-collection id="bzCollection"
                               tabindex="-1"
                               route="{{route}}"
                                data="[[appCollection]]"
                                on-click="_toggleMenu"></bz-collection>
            </div>

                <app-info id="appInfo" on-click-menu="_toogleMenu"
                          app-name="[[selectedApp.name]]"
                          short-description="[[selectedApp.shortDescription]]"
                          citation="[[selectedApp.citation]]"
                          description="[[selectedApp.completeDescription]]"
                          publications="[[selectedApp.publications]]"
                          screenshots="[[selectedApp.screenshots]]"
                          maintained="[[selectedApp.maintained]]">

                    <!-- Banner content -->
                        <i class="fa fa-bars menu_burger banner_item banner_left" on-click="_toggleMenu"></i>
                        <span class="banner_item banner banner_name">[[selectedApp.name]]</span>
                        <app-search class="search_box banner_item banner_right" id="searchBox" data="[[appCollection]]"></app-search>
                </app-info>

            <div class="blocking_div" id="blockingDiv" on-click="_toggleMenu" hidden></div>
        </div>
    </template>
    <script>
        Polymer({
            is: "bioinfo-apps-main",

            properties: {
                route: {
                    type: Object,
                    observer: "_handleUrl"
                },
                appCollection: Array/Object,
                /**
                 * Url for the json which contains the apps information
                 */
                _jsonSrc: {
                    type: String,
                    value: "src/test-apps.json"
                },

                /**
                 * Placeholder for all the information about an app to pass to the different components
                 */
                selectedApp:  Object
            },

            ready: function() {
                jsonUtils.jsonRequest(this._jsonSrc, function(response){ // Load the apps info from json file
                    this.appCollection = response;
                }.bind(this));
            },

            /**
             * Every time called, manages to hide or show the menu
             * @private
             */
            _toggleMenu: function(){
                if(this.$.menuWrapper.hasAttribute("show")){
                    Polymer.dom(this.$.menuWrapper).removeAttribute("show");
                    Polymer.dom(this.$.blockingDiv).setAttribute("hidden", "");
                } else {
                    this.$.menuWrapper.setAttribute("show", "");
                    this.$.blockingDiv.removeAttribute("hidden");
                }
            },

            /**
             * Looks for the app requested in the url and set it to the `selectedApp`
             * @private
             */
            _handleUrl: function(){
                if(!this.route.path){
                    this.set("route.path", "/babelomics");
                }
                // Needed to be async because in the first load of the page appCollection isn't set yet
                this.async(function(){
//                    this._toggleMenu();
                    var app = this.appCollection.find(searchApp, this);
                    this.$.appInfo.appToDisplay = app;
                    this.selectedApp = app;
                    this.$.appInfo.scrollTop = 0; // Default scroll position
                    this.$.bzCollection.setAppActiveByName(this.applicationData.application);
                    this._toggleMenu(); // Hack to avoid the menu being shown when the page loads
                }, 200);

                // Helper inner function to use with find() method.
                function searchApp(app){
                    var appOnRoute = this.applicationData.application.toLowerCase();
                    return appOnRoute === app.name.toLowerCase();
                }
            }
        })
    </script>
</dom-module>